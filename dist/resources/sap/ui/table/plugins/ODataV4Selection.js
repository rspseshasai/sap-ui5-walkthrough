/*
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./SelectionPlugin","./SelectionMode","./PluginBase","../library","../utils/TableUtils","sap/ui/core/Icon","sap/ui/core/IconPool"],function(e,t,i,n,o,s,r){"use strict";const l=o.createWeakMapFacade();const c=e.extend("sap.ui.table.plugins.ODataV4Selection",{metadata:{library:"sap.ui.table",properties:{selectionMode:{type:"sap.ui.table.plugins.SelectionMode",group:"Behavior",defaultValue:t.MultiToggle},limit:{type:"int",group:"Behavior",defaultValue:200},enableNotification:{type:"boolean",group:"Behavior",defaultValue:false},hideHeaderSelector:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{icon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"}}}});c.findOn=i.findOn;c.prototype.init=function(){e.prototype.init.apply(this,arguments);const t=new s({src:r.getIconURI(o.ThemeParameters.checkboxIcon),useIconTooltip:false});t.addStyleClass("sapUiTableSelectClear");this.setAggregation("icon",t,true);l(this).bLimitReached=false;l(this).oRangeSelectionStartContext=null};c.prototype.onActivate=function(t){const i=t.getBinding();f(this,i);e.prototype.onActivate.apply(this,arguments);t.setProperty("selectionMode",this.getSelectionMode());C(this,i);o.Hook.register(t,o.Hook.Keys.Table.RowsBound,S,this)};c.prototype.onDeactivate=function(t){e.prototype.onDeactivate.apply(this,arguments);t.setProperty("selectionMode",n.SelectionMode.None);clearTimeout(this.iSelectionChangeTimeout);delete this.iSelectionChangeTimeout;y(this,t.getBinding());o.Hook.deregister(t,o.Hook.Keys.Table.RowsBound,S,this)};c.prototype.setSelected=function(e,i,n){const o=e.getRowBindingContext();const s=this.getSelectionMode();if(!this.isActive()||!o||!b(o)){return}if(n?.range){a(this,e);return}if(this.isSelected(e)===i){return}if(s===t.Single&&i){this.clearSelection()}o.setSelected(i);l(this).oRangeSelectionStartContext=i&&s===t.MultiToggle?o:null};function a(e,t){if(!l(e).oRangeSelectionStartContext){return}let i=l(e).oRangeSelectionStartContext.getIndex();const n=t.getRowBindingContext();const o=n?n.getIndex():-1;if(i!==o){i+=o>i?1:-1}x(e,i,o)}c.prototype.isSelected=function(e){const t=e.getRowBindingContext();return t?this.isActive()&&t.isSelected():false};c.prototype.getSelectedCount=function(){return this.getSelectedContexts().length};function g(e){const t=e.getControl()?.getBinding();if(!t){return 0}if(!t.isLengthFinal()){return-1}const i=t.getAggregation();const n="hierarchyQualifier"in(i||{});const o=!n&&!!i;let s=-1;if(o){const i=e.aAllCurrentContexts??t.getAllCurrentContexts();if(t.getLength()===i.length){s=i.filter(b).length}}else{s=t.getLength()}return s}function u(e){if(e._isLimitDisabled()){return}let t=r.getIconURI(o.ThemeParameters.checkboxIcon);if(e.getSelectedCount()>0){if(h(e)){t=r.getIconURI(o.ThemeParameters.allSelectedIcon)}else{t=r.getIconURI(o.ThemeParameters.clearSelectionIcon)}}e.getAggregation("icon").setSrc(t)}c.prototype.getRenderConfig=function(){if(!this.isActive()){return e.prototype.getRenderConfig.apply(this,arguments)}this.aAllCurrentContexts=this.getControl().getBinding()?.getAllCurrentContexts();u(this);const i={headerSelector:{type:this._isLimitDisabled()?"toggle":"custom",icon:this.getAggregation("icon"),visible:this.getSelectionMode()===t.MultiToggle&&!this.getHideHeaderSelector(),enabled:g(this)!==0,selected:h(this),tooltip:this.getSelectedCount()===0?o.getResourceText("TBL_SELECT_ALL"):o.getResourceText("TBL_DESELECT_ALL")}};delete this.aAllCurrentContexts;return i};function d(e){if(h(e)){e.clearSelection();return false}else if(e._isLimitDisabled()){const t=e.getControl()?.getBinding();if(t?.getLength()){x(e,0,t.getLength()-1);return true}}return undefined}function h(e){const t=g(e);return t>0&&t===e.getSelectedCount()}c.prototype.onHeaderSelectorPress=function(){if(!this.isActive()){return}const e=this.getRenderConfig();if(!e.headerSelector.visible||!e.headerSelector.enabled){return}if(e.headerSelector.type==="toggle"){d(this)}else if(e.headerSelector.type==="custom"){if(this.getSelectedCount()>0){this.clearSelection()}else{const e=this.getControl()?.getBinding();if(e?.getLength()>0){x(this,0,e.getLength()-1)}}}};c.prototype.onKeyboardShortcut=function(e,i){if(!this.isActive()){return}if(e==="toggle"){if(this.getSelectionMode()!==t.MultiToggle){return}if(this._isLimitDisabled()){if(d(this)===false){i.setMarked("sapUiTableClearAll")}}else{const e=this.getControl()?.getBinding();if(e?.getLength()>0){x(this,0,e.getLength()-1)}}}else if(e==="clear"){this.clearSelection();i.setMarked("sapUiTableClearAll")}};c.prototype.setSelectionMode=function(e){const t=this.getControl();this.setProperty("selectionMode",e,true);l(this).oRangeSelectionStartContext=null;this.clearSelection();if(t){t.setProperty("selectionMode",this.getSelectionMode())}return this};c.prototype.setLimit=function(e){this.setProperty("limit",e);l(this).bLimitReached=false;return this};function f(e,t){if(!t){return}if(!t.getModel().isA("sap.ui.model.odata.v4.ODataModel")){throw new Error("Model must be sap.ui.model.odata.v4.ODataModel")}p(e,t)}function p(e,i,n){const o=[i.getHeaderContext(),...i.getAllCurrentContexts()].filter(e=>e?.isSelected());let s=o;if(n){s=n.isSelected()?[n]:[]}for(const e of s){if(e===i.getHeaderContext()){throw new Error("Header context must not be selected")}if(!b(e)){throw new Error(`Context ${e} is not allowed to be selected`)}}if(e.getSelectionMode()===t.Single&&o.length>1){throw new Error("Multiple contexts selected. Cannot select more than one context in selection mode 'Single'")}}function S(e){f(this,e);C(this,e)}function C(e,t){t?.attachEvent("selectionChanged",m,e)}function y(e,t){t?.detachEvent("selectionChanged",m,e)}function m(e){const t=e.getParameter("context");try{p(this,t.getBinding(),t)}catch(e){t.setSelected(false);throw e}if(this.iSelectionChangeTimeout){return}this.iSelectionChangeTimeout=setTimeout(()=>{this.fireSelectionChange();delete this.iSelectionChangeTimeout},0)}c.prototype._isLimitDisabled=function(){return this.getLimit()===0};function x(e,t,i){const n=e.getControl();const s=e.getLimit();const r=i<t;let c=r?i:t;let a=Math.abs(i-t)+1;if(!e._isLimitDisabled()){l(e).bLimitReached=a>s;if(l(e).bLimitReached){if(r){i=t-s+1;c=i}else{i=t+s-1}a=s+1}}o.loadContexts(n.getBinding(),c,a).then(function(t){t.forEach(function(t){if(!b(t)||t.isSelected()){return}if(r&&t.getIndex()>=i||t.getIndex()<=i){t.setSelected(true)}if(t.getIndex()===i){l(e).oRangeSelectionStartContext=t}});if(l(e).bLimitReached){o.scrollTableToIndex(n,i,r).then(function(){if(e.getEnableNotification()){o.showNotificationPopoverAtIndex(n,i,e.getLimit())}})}})}function b(e){const t=e.getBinding();const i=e===t.getHeaderContext();const n=e.getProperty("@$ui5.node.isExpanded")===undefined;const o=e.getProperty("@$ui5.node.isTotal");const s="hierarchyQualifier"in(t.getAggregation()||{});return!i&&(s||n&&!o)}c.prototype.clearSelection=function(){for(const e of this.getSelectedContexts()){e.setSelected(false)}};c.prototype.getSelectedContexts=function(){const e=this.getControl()?.getBinding();if(!this.isActive()||!e){return[]}const t=this.aAllCurrentContexts??e.getAllCurrentContexts();return t.filter(e=>e.isSelected())};c.prototype.onThemeChanged=function(){u(this)};return c});
//# sourceMappingURL=ODataV4Selection.js.map